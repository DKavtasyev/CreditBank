[![codecov ms deal](https://codecov.io/github/DKavtasyev/CreditBank/branch/feature%2Fadd_docker_and_ci/graph/badge.svg?flag=deal&token=EG63IGUXHV)](https://codecov.io/github/DKavtasyev/CreditBank)
# MS Deal
### Документация API
Для просмотра и тестирования доступных API методов используется Swagger UI, который доступен по следующему адресу:
> http://localhost:8081/swagger-ui/index.html

### Функции:
1. Создание заявки на кредит и сохранение её в базу данных. Запрос в МС Calculator расчёта предложений по кредиту,
предоставление их пользователю.
2. Применение выбранного пользователем предложения.
3. Сохранение рассчитанного кредита в базу данных.
4. Обработка отказа пользователя от кредита.
5. Создание документов на кредит и отсылка их пользователю.
6. Создание цифровой подписи, подписание документов. 
7. Проверка подлинности подписи и документа.
8. Изменение вручную статуса заявки на кредит.
9. Получение заявки по её идентификатору.
10. Получение списка всех заявок.
11. Отправка асинхронных сообщений в модуль Dossier при ключевых событиях в оформлении кредита.

### 1. Предварительный расчёт кредитных предложений
#### 1.1 Сведения о запросе и ответе

- Путь: /deal/statement
- Метод: POST
- Тело запроса: LoanStatementRequestDto
- Тело ответа: List&lt;LoanOfferDto>

Возможные коды ответа:
- 200 OK - заявка успешно создана и сохранена.
- 400 Bad request - предоставленные паспортные данные не совпадают с имеющимися в базе данных.
- 500 Internal server error - ошибка валидации входных данных LoanStatementDto.

### 2. Создание заявки на кредит и сохранение её в базу данных
#### 2.1 Сведения о запросе и ответе

- Путь: /deal/offer/select
- Метод: POST
- Тело запроса: LoanOfferDto
- Тело ответа: -

Возможные коды ответа:
- 200 OK - выбранное кредитное предложение успешно сохранено.
- 404 Not found - заявка, указанная в предложении, не найдена.
- 500 Internal server error - ошибка при отправке сообщения пользователю.

### 3. Сохранение рассчитанного кредита в базу данных
#### 3.1 Сведения о запросе и ответе

- Путь: /deal/calculate/{statementId}
- Метод: POST
- Тело запроса: FinishingRegistrationRequestDto
- Тело ответа: -

Возможные коды ответа:
- 200 OK - кредит успешно рассчитан и сохранен.
- 404 Not found - заявка c указанным идентификатором statementId не найдена.
- 406 Not acceptable - данные пользователя не соответствуют требованиям для получения кредита (неудачный скоринг).
- 428 Precondition Required - заявка не была предварительно одобрена.
- 500 Internal server error - ошибка при отправке пользователю сообщения, ошибка при взаимодействии с модулем Calculator.

### 4. Обработка отказа пользователя от кредита
#### 4.1 Сведения о запросе и ответе

- Путь: /deal/offer/deny/{statementId}
- Метод: GET
- Тело запроса: -
- Тело ответа: -

Возможные коды ответа:
- 200 OK - отказ от кредита успешно сохранён.
- 404 Not found - заявка c указанным идентификатором statementId не найдена.
- 500 Internal server error - ошибка при отправке сообщения пользователю.

### 5. Создание документов на кредит и отсылка их пользователю
#### 5.1 Сведения о запросе и ответе

- Путь: /deal/document/{statementId}/send
- Метод: POST
- Тело запроса: -
- Тело ответа: -

Возможные коды ответа:
- 200 OK - документы успешно созданы и отправлены пользователю.
- 404 Not found - заявка c указанным идентификатором statementId не найдена.
- 422 Unprocessable Entity - попытка создания документа до завершения оформления кредита.
- 500 Internal server error - ошибка при отправке пользователю сообщения или при создании документа.

### 6. Создание цифровой подписи, подписание документов
#### 6.1 Сведения о запросе и ответе

- Путь: /deal/document/{statementId}/sign
- Метод: POST
- Тело запроса: -
- Тело ответа: -

Возможные коды ответа:
- 200 OK - подпись успешно создана, документы подписаны.
- 404 Not found - заявка c указанным идентификатором statementId не найдена.
- 422 Unprocessable Entity - попытка подписания документа до завершения оформления кредита или до создания документов.
- 500 Internal server error - ошибка может возникнуть:
  - при создании подписи
  - при подписании документа
  - при отправке пользователю сообщения

### 7. Проверка подлинности подписи и документа
#### 7.1 Сведения о запросе и ответе

- Путь: /deal/document/{statementId}/code
- Метод: POST
- Тело запроса: -
- Тело ответа: -

Возможные коды ответа:
- 200 OK - проверка подписи прошла успешно.
- 400 Bad request - подпись или документ не подлинные.
- 404 Not found - заявка c указанным идентификатором statementId не найдена.
- 422 Unprocessable Entity - попытка проверки подписи до завершения оформления кредита, до создания или подписания
документа.
- 500 Internal server error - ошибка при отправке пользователю сообщения или при проверке подписи.

### 8. Проверка подлинности подписи и документа
#### 8.1 Сведения о запросе и ответе

- Путь: /deal/admin/statement/{statementId}/status
- Метод: PUT
- Тело запроса: ApplicationStatus
- Тело ответа: -
- Параметры запроса
  - code - подпись, подлинность которой подлежит проверке

Возможные коды ответа:
- 200 OK - статус заявки успешно обновлён.
- 404 Not found - заявка c указанным идентификатором statementId не найдена.

### 9. Получение заявки по её идентификатору
#### 9.1 Сведения о запросе и ответе

- Путь: /deal/admin/statement/{statementId}
- Метод: GET
- Тело запроса: -
- Тело ответа: Statement

Возможные коды ответа:
- 200 OK - заявка найдена и возвращена.
- 404 Not found - заявка c указанным идентификатором statementId не найдена.

### 10. Получение списка всех заявок
#### 10.1 Сведения о запросе и ответе

- Путь: /deal/admin/statement
- Метод: GET
- Тело запроса: -
- Тело ответа: List&lt;Statement>
- Параметры запроса (query params)
  - page - номер страницы (пагинация)

Возможные коды ответа:
- 200 OK - возвращение списка заявок

### 11. Отправка асинхронных сообщений в модуль Dossier при ключевых событиях в оформлении кредита
#### 11.1 Уведомление о предварительном одобрении заявки
При выборе пользователем кредитного предложения отправляется сообщение по Kafka в модуль Dossier о предварительном
одобрении заявки на кредит.
> Kafka topic: \
> finish-registration
#### 11.2 Уведомление об одобрении заявки
После предоставления клиентом всех необходимых данных отправляется сообщение по Kafka в модуль Dossier об одобрении
заявки и предложении сформировать кредитные документы.
> Kafka topic: \
> create-documents
#### 11.3 Оформление документов
После формирования документов отправляется сообщение по Kafka в модуль Dossier с документом и предложением клиенту
ознакомиться с условиями договора и дать своё согласие.
> Kafka topic: \
> send-documents
#### 11.4 Подписание документов
После получения согласия от клиента отправляется сообщение по Kafka в модуль Dossier с предложением подписать документы
с использованием электронной подписи.
> Kafka topic: \
> send-ses
#### 11.5 Уведомление об оформленном кредите
После того как документы подписаны, оформление кредита закончено, в модуль Dossier отправляется сообщение по Kafka с
уведомлением о выпущенном кредите.
> Kafka topic: \
> credit-issued
#### 11.6 Уведомление об отказе в получении кредита
В случае несоответствия данных клиента требованиям для получения кредита (неудачный скоринг), отправляется сообщение по
Kafka в модуль Dossier с уведомлением об отказе в кредите.
> Kafka topic: \
> statement-denied
#### 11.7 Уведомление об отказе клиента от кредита
Если клиент отказался от кредита, отправляется сообщение по Kafka в модуль Dossier с уведомлением об отказе пользователя
от кредита.
> Kafka topic: \
> client-rejection

[К основному README](./../README.md)